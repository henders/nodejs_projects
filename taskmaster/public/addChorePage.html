<div id="addChore">
	<form action="/do_chore" id="createTaskForm" method="post" name="createTask">
		<fieldset data-role="controlgroup" data-role="fieldcontain">
			<label for="choreName">Chore</label>
			<input type="text" id="choreName" name="chore" autofocus required placeholder="Start typing for autocomplete...">
		</fieldset>
		<fieldset data-role="controlgroup"  data-type="horizontal" data-role="fieldcontain">
			<label for="personName">Person</label>
			<input type="text" id="personName" name="person" placeholder=""><br/>
		</fieldset>
		<fieldset data-role="fieldcontain">
			<label for="timeSlider">Time: </label>
			<input type="range" name="timeSlider" id="timeSlider" value="30" min="10" max="120"/>
		</fieldset>
		<input type="submit" id='choreSubmit' value="Do it!"/>
	</form>
</div>

<br/>

<br/>
	<header>
		<hgroup>
			<h4><u>Leader Board</u></h4>
		</hgroup>
	</header>
<div id="leaderboardDiv" title="Leader Board" class="graph"></div>

<script type="text/javascript" charset="utf-8">

	$('#createTaskForm').submit(function(e) {
		var params = {};
		params.choreType = $('#choreName').val();
		params.person = $('#personName').val();
		params.time = $('#timeSlider').val();
		var sig = createSignature('/chores/do', params);

		console.log("submitting chore: " + JSON.stringify(params));
		$.post('/chores/do', {signature: sig, param: JSON.stringify(params)}, function(result) {
			console.log("Got do-chore result: " + JSON.stringify(result));
			$.cookie('taskmaster', JSON.stringify(taskmaster));
			// now load addChorePage
			$('#chores_icon').click();
		}, "json");

		return false;
	});

	// Delay executing the chore stuff until we login
	$( '#addChorePage' ).live( 'pageshow', function(event) {
		console.log('Entering page: addChorePage: ' + JSON.stringify(event));

		function createLeaderBoard() {
			var leaderBoardData = [];
			var userIds = [taskmaster.user.id];
			$.each(taskmaster.friends, function(i) { userIds.push(taskmaster.friends[i].friend_user_id); });
			var drawleaderBoard = function() {
				$.plot($('#leaderboardDiv'), leaderBoardData, {
					series: {
						lines: {show: false},
						bars: { 
							show: true,
							barWidth: 0.5,
							horizontal: true
						}
					},
					xaxis: { min: 0},
					yaxis: { ticks: 0, max: userIds.length },
					//xaxis: { tickLength: 0},
					legend: { position: "se"},
					grid: {borderWidth: 0},
				});
			};

			// Want to reverse sort the array
			function sortLeaders(a, b) {
				return a.data[0][0] - b.data[0][0];
			}

			// Load dynamic data for graphs
			console.log('List of Users:' + JSON.stringify(userIds));
			$.each(userIds, function(i) {	
				var params = {
					username: taskmaster.user.email
				};
				var sig = createSignature('/user/getUserPoints/' + userIds[i], params);
				console.log('requesting userpoints for: '+ userIds[i]);
				$.getJSON('/user/getUserPoints/' + userIds[i], {signature: sig, param: JSON.stringify(params)}, function(pointData) { 
					if (pointData.error) {
						showMsg(pointData.error);
					}
					else {
						leaderBoardData.push({
							label: pointData.name,
							data: [[pointData.points, 0]]
						});
						leaderBoardData.sort(sortLeaders);
						// Fix vertical ordering as well
						for (var i = 0; i < leaderBoardData.length; i++) {
							leaderBoardData[i].data[0][1] = i + 0.3;
						}
						drawleaderBoard();
					}	
				});
			});

			// Set the height of the leaderBoardData
			$('#leaderboardDiv').height(Math.min( userIds.length * 50, 200));
		}

		var params = {
			username: taskmaster.user.email
		};			
		var sig = createSignature('/chores/types', params);
		$.getJSON('/chores/types', {signature: sig, param: JSON.stringify(params)}, function(data) {
			if (data.error) {
				console.log('Encountered error: ' + data.error);
				showMsg(data.error);
			}
			else {
				var types = [];
				taskmaster.choreTypes = data;
				$.each(data, function(i) { types.push(data[i].name); });
				$('#choreName').autocomplete( { source: types } );
			}
		});

		var params = {
			username: taskmaster.user.email
		};			
		var sig = createSignature('/friends/list', params);
		$.getJSON('/friends/list', {signature: sig, param: JSON.stringify(params)}, function(data) {
			if (data.error) {
				console.log('Encountered error: ' + data.error);
				showMsg(data.error);
			}
			else {
				var friends = [taskmaster.user.name];
				taskmaster.friends = data;
				$.each(data, function(i) { friends.push(data[i].friend.name); });
				$('#personName').autocomplete( { source: friends }, { selectFirst: true });
				$('#personName').val(taskmaster.user.name);
				createLeaderBoard();
			}
		});
	});
</script>
